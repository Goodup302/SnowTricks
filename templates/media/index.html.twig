{% import "macro/media.html.twig" as media_item %}
<div id="media_picker">

    <div id="media_content" class="row">
        <div class="col-12">
            <i id="close_media" class="fas fa-times"></i>
            {{ form_start(form) }}
            {{ form_widget(form.files) }}
            {{ form_end(form) }}
        </div>
        <div class="col-12 row">
            {% for media in medias %}
                {{ media_item.image(media) }}
            {% endfor %}
        </div>

    </div>

    <script>
        $(document).ready(function() {
            var inputId = '{{ form.files.vars.id }}';
            var inputName = '{{ form.files.vars.full_name }}';
            $("#close_media").click(function (){
                $("#media_picker").remove();
            });

            $('#'+inputId+':file').change(function(){
                $(this).prop('disabled', true);
                var input = $(this);
                var formData = new FormData(document.getElementsByName('media')[0]);
                var files = document.getElementById(inputId).files;

                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    if (file.type.match('image.*')) {
                        formData.append(inputName, file, file.name);
                    }
                }
                console.log(formData.getAll(inputName));
                $.ajax({
                    type: "POST",
                    url: '{{ path('media.add') }}',
                    data: formData,
                    processData: false,
                    contentType: false,
                    error: function(jqXHR, textStatus, errorMessage) {
                        console.log(errorMessage);
                        input.prop('disabled', false);
                        Swal.fire({
                            type: 'error',
                            title: 'Oops...',
                            text: "Le ou les fichiers n'ont pas pus ètre traités !"
                        })
                    },
                    success: function(data) {
                        console.log(data);
                        input.prop('disabled', false);
                    }
                });
            });

            $(".media_item .delete").click(function(){
                var input = $(this);
                var id = $(this).attr('itemid');
                var url = $(this).attr('action');
                $.ajax({
                    type: "POST",
                    url: url,
                    data: {
                        id: id,
                        _method: "DELETE"
                    },
                    error: function(jqXHR, textStatus, errorMessage) {
                        console.log(errorMessage);
                        Swal.fire({
                            type: 'error',
                            title: 'Oops...',
                            text: "Suppression impossible (Réessayer plus tard) !"
                        })
                    },
                    success: function(data) {
                        input.parent().remove();
                    }
                });
            });
        });
    </script>
</div>